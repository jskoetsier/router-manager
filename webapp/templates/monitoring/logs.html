{% extends "base.html" %}
{% load static %}

{% block title %}System Logs Aggregation{% endblock %}

{% block extra_css %}
<style>
.logs-card {
    background: white;
    border-radius: 10px;
    padding: 20px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    margin-bottom: 20px;
}

.log-entry {
    padding: 10px 15px;
    margin-bottom: 5px;
    border-radius: 4px;
    font-family: 'Courier New', monospace;
    font-size: 0.85em;
    border-left: 3px solid #dee2e6;
    word-break: break-all;
}

.log-entry.DEBUG {
    background: #f8f9fa;
    border-left-color: #6c757d;
    color: #6c757d;
}

.log-entry.INFO {
    background: #d1ecf1;
    border-left-color: #17a2b8;
    color: #0c5460;
}

.log-entry.WARNING {
    background: #fff3cd;
    border-left-color: #ffc107;
    color: #856404;
}

.log-entry.ERROR {
    background: #f8d7da;
    border-left-color: #dc3545;
    color: #721c24;
}

.log-entry.CRITICAL {
    background: #f5c6cb;
    border-left-color: #a71e2a;
    color: #721c24;
    font-weight: bold;
}

.stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 20px;
    margin-bottom: 30px;
}

.stat-card {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border-radius: 10px;
    padding: 20px;
    text-align: center;
}

.stat-card.total { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
.stat-card.error { background: linear-gradient(135deg, #fc466b 0%, #3f5efb 100%); }
.stat-card.warning { background: linear-gradient(135deg, #fdbb2d 0%, #22c1c3 100%); }
.stat-card.info { background: linear-gradient(135deg, #74b9ff 0%, #0984e3 100%); }

.stat-value {
    font-size: 2.5em;
    font-weight: bold;
    margin-bottom: 5px;
}

.stat-label {
    font-size: 0.9em;
    opacity: 0.9;
}

.filter-panel {
    background: white;
    border-radius: 10px;
    padding: 20px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    margin-bottom: 20px;
}

.log-timestamp {
    color: #6c757d;
    font-weight: bold;
}

.log-source {
    color: #495057;
    font-weight: 600;
    text-transform: uppercase;
}

.log-message {
    margin-left: 10px;
    flex: 1;
}

.log-item-content {
    display: flex;
    align-items: flex-start;
    gap: 10px;
}

.search-highlight {
    background: #ffeb3b;
    padding: 2px 4px;
    border-radius: 3px;
}

.live-toggle {
    display: flex;
    align-items: center;
    gap: 10px;
}

.live-indicator {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background: #28a745;
    animation: pulse 2s infinite;
}

@keyframes pulse {
    0% { transform: scale(1); opacity: 1; }
    50% { transform: scale(1.2); opacity: 0.7; }
    100% { transform: scale(1); opacity: 1; }
}

.log-metadata {
    font-size: 0.75em;
    color: #6c757d;
    margin-top: 5px;
}

.quick-filters {
    display: flex;
    gap: 10px;
    margin-bottom: 15px;
    flex-wrap: wrap;
}

.quick-filter-btn {
    padding: 4px 12px;
    border: 1px solid #dee2e6;
    background: white;
    border-radius: 15px;
    font-size: 0.8em;
    cursor: pointer;
    transition: all 0.2s;
}

.quick-filter-btn.active {
    background: #007bff;
    color: white;
    border-color: #007bff;
}

.log-details-panel {
    background: #f8f9fa;
    border-radius: 6px;
    padding: 15px;
    margin-top: 10px;
    display: none;
}

.export-options {
    display: flex;
    gap: 10px;
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1><i class="fas fa-file-alt"></i> System Logs Aggregation</h1>
        <div class="d-flex gap-2">
            <div class="live-toggle">
                <span class="live-indicator"></span>
                <small class="text-muted">Live Tailing</small>
            </div>
            <button class="btn btn-outline-primary btn-sm" onclick="refreshLogs()">
                <i class="fas fa-sync-alt"></i> Refresh
            </button>
            <div class="export-options">
                <button class="btn btn-outline-success btn-sm" onclick="exportLogs('csv')">
                    <i class="fas fa-file-csv"></i> CSV
                </button>
                <button class="btn btn-outline-info btn-sm" onclick="exportLogs('json')">
                    <i class="fas fa-file-code"></i> JSON
                </button>
            </div>
        </div>
    </div>

    <!-- Log Statistics -->
    <div class="stats-grid">
        <div class="stat-card total">
            <div class="stat-value">{{ log_stats.total }}</div>
            <div class="stat-label">Total Entries</div>
        </div>
        <div class="stat-card error">
            <div class="stat-value">{{ log_stats.error_count }}</div>
            <div class="stat-label">Errors</div>
        </div>
        <div class="stat-card warning">
            <div class="stat-value">{{ log_stats.warning_count }}</div>
            <div class="stat-label">Warnings</div>
        </div>
        <div class="stat-card info">
            <div class="stat-value">{{ log_stats.info_count }}</div>
            <div class="stat-label">Info Messages</div>
        </div>
    </div>

    <div class="row">
        <!-- Logs List -->
        <div class="col-md-9">
            <!-- Filter Panel -->
            <div class="filter-panel">
                <form method="get" id="filterForm" class="row g-3">
                    <div class="col-12">
                        <div class="quick-filters">
                            <button type="button" class="quick-filter-btn {% if level_filter == 'all' %}active{% endif %}"
                                    onclick="setQuickFilter('level', 'all')">All Levels</button>
                            <button type="button" class="quick-filter-btn {% if level_filter == 'ERROR' %}active{% endif %}"
                                    onclick="setQuickFilter('level', 'ERROR')">Errors Only</button>
                            <button type="button" class="quick-filter-btn {% if level_filter == 'WARNING' %}active{% endif %}"
                                    onclick="setQuickFilter('level', 'WARNING')">Warnings Only</button>
                            <button type="button" class="quick-filter-btn {% if source_filter == 'auth' %}active{% endif %}"
                                    onclick="setQuickFilter('source', 'auth')">Auth Logs</button>
                            <button type="button" class="quick-filter-btn {% if source_filter == 'router-manager' %}active{% endif %}"
                                    onclick="setQuickFilter('source', 'router-manager')">App Logs</button>
                        </div>
                    </div>

                    <div class="col-md-3">
                        <label class="form-label">Source</label>
                        <select name="source" class="form-select" onchange="this.form.submit()">
                            <option value="all" {% if source_filter == 'all' %}selected{% endif %}>All Sources</option>
                            {% for source in available_sources %}
                                <option value="{{ source }}" {% if source_filter == source %}selected{% endif %}>
                                    {{ source|title }}
                                </option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">Level</label>
                        <select name="level" class="form-select" onchange="this.form.submit()">
                            <option value="all" {% if level_filter == 'all' %}selected{% endif %}>All Levels</option>
                            {% for level in available_levels %}
                                <option value="{{ level }}" {% if level_filter == level %}selected{% endif %}>
                                    {{ level }}
                                </option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">Time Range</label>
                        <select name="hours" class="form-select" onchange="this.form.submit()">
                            <option value="1" {% if hours_filter == '1' %}selected{% endif %}>1 Hour</option>
                            <option value="6" {% if hours_filter == '6' %}selected{% endif %}>6 Hours</option>
                            <option value="24" {% if hours_filter == '24' %}selected{% endif %}>24 Hours</option>
                            <option value="168" {% if hours_filter == '168' %}selected{% endif %}>1 Week</option>
                        </select>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Search</label>
                        <div class="input-group">
                            <input type="text" name="search" class="form-control"
                                   placeholder="Search log messages..."
                                   value="{{ search_query }}">
                            <button type="submit" class="btn btn-outline-secondary">
                                <i class="fas fa-search"></i>
                            </button>
                        </div>
                    </div>
                    <div class="col-md-1">
                        <label class="form-label">&nbsp;</label>
                        <div>
                            <a href="{% url 'monitoring:logs' %}" class="btn btn-outline-danger w-100">
                                Clear
                            </a>
                        </div>
                    </div>
                </form>
            </div>

            <!-- Log Entries -->
            <div class="logs-card">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5><i class="fas fa-stream"></i> Log Entries ({{ logs.paginator.count }})</h5>
                    <div class="d-flex gap-2">
                        <button class="btn btn-outline-secondary btn-sm" onclick="toggleAutoScroll()">
                            <i class="fas fa-arrow-down"></i> Auto Scroll
                        </button>
                        <button class="btn btn-outline-info btn-sm" onclick="showLogAnalysis()">
                            <i class="fas fa-chart-bar"></i> Analysis
                        </button>
                    </div>
                </div>

                <div id="logContainer" style="max-height: 600px; overflow-y: auto;">
                    {% for log in logs %}
                        <div class="log-entry {{ log.level }}" onclick="toggleLogDetails(this)">
                            <div class="log-item-content">
                                <span class="log-timestamp">{{ log.timestamp|date:"H:i:s" }}</span>
                                <span class="log-source">[{{ log.source }}]</span>
                                <div class="log-message">
                                    {% if search_query %}
                                        {{ log.message|safe }}
                                    {% else %}
                                        {{ log.message }}
                                    {% endif %}
                                </div>
                                <small class="text-muted">
                                    <i class="fas fa-chevron-down"></i>
                                </small>
                            </div>

                            <div class="log-details-panel">
                                <div class="row">
                                    <div class="col-md-6">
                                        <p><strong>Timestamp:</strong> {{ log.timestamp }}</p>
                                        <p><strong>Level:</strong> {{ log.level }}</p>
                                        <p><strong>Source:</strong> {{ log.source }}</p>
                                        {% if log.hostname %}
                                            <p><strong>Hostname:</strong> {{ log.hostname }}</p>
                                        {% endif %}
                                    </div>
                                    <div class="col-md-6">
                                        {% if log.process %}
                                            <p><strong>Process:</strong> {{ log.process }}</p>
                                        {% endif %}
                                        {% if log.facility %}
                                            <p><strong>Facility:</strong> {{ log.facility }}</p>
                                        {% endif %}
                                        {% if log.metadata %}
                                            <p><strong>Metadata:</strong>
                                                <code>{{ log.metadata|truncatechars:100 }}</code>
                                            </p>
                                        {% endif %}
                                    </div>
                                </div>

                                <div class="mt-3">
                                    <strong>Full Message:</strong>
                                    <pre class="bg-light p-2 mt-2" style="white-space: pre-wrap;">{{ log.message }}</pre>
                                </div>

                                <div class="mt-3">
                                    <button class="btn btn-outline-warning btn-sm" onclick="createAlertFromLog(event, '{{ log.level }}', '{{ log.source }}')">
                                        <i class="fas fa-bell"></i> Create Alert
                                    </button>
                                    <button class="btn btn-outline-info btn-sm" onclick="filterBySimilar(event, '{{ log.process }}')">
                                        <i class="fas fa-filter"></i> Similar Logs
                                    </button>
                                    <button class="btn btn-outline-secondary btn-sm" onclick="copyLogEntry(event, this)">
                                        <i class="fas fa-copy"></i> Copy
                                    </button>
                                </div>
                            </div>
                        </div>
                    {% empty %}
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle"></i> No log entries found matching the current filters.
                            <br><small>Try adjusting the time range or clearing filters.</small>
                        </div>
                    {% endfor %}
                </div>

                <!-- Pagination -->
                {% if logs.has_other_pages %}
                    <nav class="mt-4">
                        <ul class="pagination justify-content-center">
                            {% if logs.has_previous %}
                                <li class="page-item">
                                    <a class="page-link" href="?page={{ logs.previous_page_number }}{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}">
                                        Previous
                                    </a>
                                </li>
                            {% endif %}

                            <li class="page-item active">
                                <span class="page-link">
                                    Page {{ logs.number }} of {{ logs.paginator.num_pages }}
                                </span>
                            </li>

                            {% if logs.has_next %}
                                <li class="page-item">
                                    <a class="page-link" href="?page={{ logs.next_page_number }}{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}">
                                        Next
                                    </a>
                                </li>
                            {% endif %}
                        </ul>
                    </nav>
                {% endif %}
            </div>
        </div>

        <!-- Log Analysis Sidebar -->
        <div class="col-md-3">
            <div class="logs-card">
                <h5><i class="fas fa-chart-line"></i> Log Trends</h5>
                <canvas id="logTrendsChart" width="250" height="200"></canvas>
            </div>

            <div class="logs-card">
                <h5><i class="fas fa-exclamation-triangle"></i> Recent Errors</h5>
                <div class="recent-errors">
                    {% for log in logs %}
                        {% if log.level == 'ERROR' %}
                            <div class="alert alert-danger alert-sm mb-2">
                                <small>
                                    <strong>{{ log.timestamp|timesince }} ago</strong><br>
                                    {{ log.message|truncatechars:80 }}
                                </small>
                            </div>
                        {% endif %}
                    {% endfor %}
                </div>
            </div>

            <div class="logs-card">
                <h5><i class="fas fa-tags"></i> Log Sources</h5>
                <div class="source-list">
                    {% for source in available_sources %}
                        <div class="d-flex justify-content-between align-items-center mb-2 p-2 bg-light rounded">
                            <span class="source-name">{{ source|title }}</span>
                            <button class="btn btn-outline-primary btn-xs"
                                    onclick="filterBySource('{{ source }}')">
                                Filter
                            </button>
                        </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Log Analysis Modal -->
<div class="modal fade" id="logAnalysisModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Log Analysis Dashboard</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-6">
                        <h6>Error Frequency</h6>
                        <canvas id="errorFrequencyChart" width="400" height="200"></canvas>
                    </div>
                    <div class="col-md-6">
                        <h6>Source Distribution</h6>
                        <canvas id="sourceDistributionChart" width="400" height="200"></canvas>
                    </div>
                </div>
                <div class="row mt-4">
                    <div class="col-12">
                        <h6>Log Pattern Analysis</h6>
                        <div id="patternAnalysis">
                            <!-- Pattern analysis results -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
let logTrendsChart;
let autoScrollEnabled = false;

document.addEventListener('DOMContentLoaded', function() {
    initializeLogTrendsChart();
    setupAutoRefresh();
    highlightSearchTerms();
});

function initializeLogTrendsChart() {
    const ctx = document.getElementById('logTrendsChart').getContext('2d');

    // Generate sample trend data
    const hours = Array.from({length: 24}, (_, i) => `${i}:00`);
    const errorData = Array.from({length: 24}, () => Math.floor(Math.random() * 10));
    const warningData = Array.from({length: 24}, () => Math.floor(Math.random() * 20));

    logTrendsChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: hours,
            datasets: [{
                label: 'Errors',
                data: errorData,
                borderColor: '#dc3545',
                backgroundColor: 'rgba(220, 53, 69, 0.1)',
                tension: 0.4
            }, {
                label: 'Warnings',
                data: warningData,
                borderColor: '#ffc107',
                backgroundColor: 'rgba(255, 193, 7, 0.1)',
                tension: 0.4
            }]
        },
        options: {
            responsive: true,
            scales: {
                y: {
                    beginAtZero: true
                }
            },
            plugins: {
                legend: {
                    position: 'bottom'
                }
            }
        }
    });
}

function setQuickFilter(type, value) {
    const form = document.getElementById('filterForm');
    const input = form.querySelector(`[name="${type}"]`);
    if (input) {
        input.value = value;
        form.submit();
    }
}

function toggleLogDetails(element) {
    const panel = element.querySelector('.log-details-panel');
    const icon = element.querySelector('.fa-chevron-down, .fa-chevron-up');

    if (panel.style.display === 'block') {
        panel.style.display = 'none';
        icon.className = 'fas fa-chevron-down';
    } else {
        // Close other open panels
        document.querySelectorAll('.log-details-panel').forEach(p => {
            p.style.display = 'none';
        });
        document.querySelectorAll('.fa-chevron-up').forEach(i => {
            i.className = 'fas fa-chevron-down';
        });

        // Open this panel
        panel.style.display = 'block';
        icon.className = 'fas fa-chevron-up';
    }
}

function createAlertFromLog(event, level, source) {
    event.stopPropagation();

    const url = new URL('{% url "monitoring:alert_create" %}', window.location.origin);
    url.searchParams.set('alert_type', 'threshold');
    url.searchParams.set('metric_type', 'system');
    url.searchParams.set('severity', level.toLowerCase());
    url.searchParams.set('name', `${source.toUpperCase()} ${level} Alert`);

    window.location.href = url.toString();
}

function filterBySimilar(event, process) {
    event.stopPropagation();

    const form = document.getElementById('filterForm');
    const searchInput = form.querySelector('[name="search"]');
    searchInput.value = process;
    form.submit();
}

function copyLogEntry(event, button) {
    event.stopPropagation();

    const logEntry = button.closest('.log-entry');
    const message = logEntry.querySelector('.log-message').textContent;
    const timestamp = logEntry.querySelector('.log-timestamp').textContent;
    const source = logEntry.querySelector('.log-source').textContent;

    const fullText = `${timestamp} ${source} ${message}`;

    navigator.clipboard.writeText(fullText).then(() => {
        button.innerHTML = '<i class="fas fa-check"></i> Copied';
        setTimeout(() => {
            button.innerHTML = '<i class="fas fa-copy"></i> Copy';
        }, 2000);
    });
}

function filterBySource(source) {
    const form = document.getElementById('filterForm');
    const sourceSelect = form.querySelector('[name="source"]');
    sourceSelect.value = source;
    form.submit();
}

function refreshLogs() {
    const button = event.target;
    const originalText = button.innerHTML;
    button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Refreshing...';
    button.disabled = true;

    setTimeout(() => {
        window.location.reload();
    }, 1000);
}

function exportLogs(format) {
    const params = new URLSearchParams(window.location.search);
    params.set('export', format);

    const url = window.location.pathname + '?' + params.toString();

    if (format === 'csv') {
        // Create CSV export
        const logs = [];
        document.querySelectorAll('.log-entry').forEach(entry => {
            const timestamp = entry.querySelector('.log-timestamp').textContent;
            const source = entry.querySelector('.log-source').textContent;
            const message = entry.querySelector('.log-message').textContent;
            const level = entry.className.match(/log-entry (\w+)/)?.[1] || '';

            logs.push([timestamp, level, source, message].map(field =>
                '"' + field.replace(/"/g, '""') + '"'
            ).join(','));
        });

        const csvContent = "data:text/csv;charset=utf-8," +
            "Timestamp,Level,Source,Message\n" + logs.join('\n');

        const encodedUri = encodeURI(csvContent);
        const link = document.createElement("a");
        link.setAttribute("href", encodedUri);
        link.setAttribute("download", `logs_${new Date().toISOString().split('T')[0]}.csv`);
        link.click();

    } else if (format === 'json') {
        alert('JSON export functionality would be implemented here.');
    }
}

function toggleAutoScroll() {
    autoScrollEnabled = !autoScrollEnabled;
    const button = event.target;

    if (autoScrollEnabled) {
        button.innerHTML = '<i class="fas fa-pause"></i> Stop Auto Scroll';
        button.classList.add('btn-warning');
        button.classList.remove('btn-outline-secondary');
    } else {
        button.innerHTML = '<i class="fas fa-arrow-down"></i> Auto Scroll';
        button.classList.remove('btn-warning');
        button.classList.add('btn-outline-secondary');
    }
}

function showLogAnalysis() {
    const modal = new bootstrap.Modal(document.getElementById('logAnalysisModal'));
    modal.show();

    // Initialize analysis charts when modal is shown
    setTimeout(() => {
        initializeAnalysisCharts();
    }, 100);
}

function initializeAnalysisCharts() {
    // Error Frequency Chart
    const errorCtx = document.getElementById('errorFrequencyChart').getContext('2d');
    new Chart(errorCtx, {
        type: 'bar',
        data: {
            labels: ['00:00', '06:00', '12:00', '18:00'],
            datasets: [{
                label: 'Error Count',
                data: [5, 12, 8, 15],
                backgroundColor: 'rgba(220, 53, 69, 0.7)'
            }]
        },
        options: {
            responsive: true,
            scales: {
                y: {
                    beginAtZero: true
                }
            }
        }
    });

    // Source Distribution Chart
    const sourceCtx = document.getElementById('sourceDistributionChart').getContext('2d');
    new Chart(sourceCtx, {
        type: 'doughnut',
        data: {
            labels: ['System', 'Auth', 'Kernel', 'Router Manager'],
            datasets: [{
                data: [30, 25, 20, 25],
                backgroundColor: ['#007bff', '#28a745', '#ffc107', '#dc3545']
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: {
                    position: 'bottom'
                }
            }
        }
    });
}

function highlightSearchTerms() {
    const searchQuery = '{{ search_query }}';
    if (searchQuery) {
        document.querySelectorAll('.log-message').forEach(element => {
            const text = element.textContent;
            const regex = new RegExp(`(${searchQuery})`, 'gi');
            element.innerHTML = text.replace(regex, '<span class="search-highlight">$1</span>');
        });
    }
}

function setupAutoRefresh() {
    // Auto-refresh every 15 seconds if on first page and no search filters
    setInterval(() => {
        const hasFilters = window.location.search.includes('search=') ||
                          window.location.search.includes('level=') ||
                          window.location.search.includes('source=');
        const isFirstPage = !window.location.search.includes('page=') ||
                           window.location.search.includes('page=1');

        if (!hasFilters && isFirstPage && !document.querySelector('.modal.show')) {
            console.log('Auto-refreshing logs...');
            // In a real implementation, you'd make an AJAX call to get new logs

            if (autoScrollEnabled) {
                const container = document.getElementById('logContainer');
                container.scrollTop = container.scrollHeight;
            }
        }
    }, 15000);
}
</script>

<style>
.btn-xs {
    padding: 2px 6px;
    font-size: 0.75em;
}

.alert-sm {
    padding: 8px 12px;
}

.source-name {
    font-weight: 500;
    font-size: 0.9em;
}
</style>
{% endblock %}
