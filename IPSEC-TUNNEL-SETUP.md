# IPSec Tunnel Configuration Guide

This guide provides instructions for configuring a routed IPSec tunnel between an external server and a Draytek Vigor 2927 router using the automated setup script.

## Overview

**Network Configuration:**
- **External Server:** `195.95.177.8` (SSH port 22123, root access, no password)
- **Draytek Vigor 2927:** `192.168.1.1` (SSH as admin user)
- **External Network:** `195.95.177.0/28`
- **Internal Network:** `192.168.1.0/24`

## Prerequisites

1. **SSH Access:**
   - External server: SSH key-based authentication configured
   - Draytek device: SSH or web interface access

2. **Network Requirements:**
   - Both devices must be reachable over the internet
   - Firewall ports for IPSec (UDP 500, 4500 and ESP protocol) must be open
   - Administrative access to both devices

3. **Software Requirements:**
   - Linux system with bash shell (for running the setup script)
   - SSH client
   - OpenSSL (for generating pre-shared keys)

## Quick Setup

### 1. Run the Automated Setup Script

```bash
cd /Users/johansebastiaan/dev/router-manager/scripts
./setup-ipsec-tunnel.sh
```

The script will:
- Test SSH connectivity to the external server
- Install and configure StrongSwan on the external server
- Configure firewall rules (nftables)
- Generate certificates and pre-shared key
- Create configuration files for both devices
- Provide manual configuration instructions for the Draytek

### 2. Configure Draytek Vigor 2927

After running the script, you'll find Draytek configuration instructions in `/tmp/draytek-config.txt`. Follow these steps:

#### Access the Draytek Web Interface
1. Open a web browser and navigate to `https://192.168.1.1`
2. Login with admin credentials

#### Create IPSec VPN Profile
1. Go to **VPN and Remote Access > LAN to LAN > Profile Setup**
2. Create a new profile with these settings:

   **Basic Settings:**
   - Profile Name: `External-Server-Tunnel`
   - Call Direction: `Dial-Out`
   - Server Type: `IPSec`
   - Remote Gateway: `195.95.177.8`

   **Authentication:**
   - Authentication Method: `Pre-Shared Key`
   - Pre-Shared Key: `[Use the key generated by the script]`
   - IKE Version: `IKEv2`
   - Mode: `Main Mode`

   **Phase 1 (IKE) Settings:**
   - Encryption: `AES-256`
   - Authentication: `SHA-256`
   - DH Group: `14 (2048-bit)`
   - Lifetime: `28800 seconds`

   **Phase 2 (IPSec) Settings:**
   - Encryption: `AES-256`
   - Authentication: `SHA-256`
   - PFS Group: `14 (2048-bit)`
   - Lifetime: `3600 seconds`

   **Network Configuration:**
   - Local Network: `192.168.1.0/255.255.255.0`
   - Remote Network: `195.95.177.0/255.255.255.240`

3. Enable the profile and set it to auto-dial

#### Configure Firewall Rules
1. Go to **Firewall > Filter Setup**
2. Create rules to allow traffic:
   - Allow `192.168.1.0/24` to `195.95.177.0/28`
   - Allow `195.95.177.0/28` to `192.168.1.0/24`

#### Save and Apply Configuration
1. Save all configurations
2. Restart the VPN service or reboot the device

## Advanced Configuration

### Custom Options

The setup script supports several command-line options:

```bash
# Use custom pre-shared key
./setup-ipsec-tunnel.sh --psk "your-custom-key"

# Configure different external server
./setup-ipsec-tunnel.sh --external-server 203.0.113.10 --external-port 2222

# Configure different Draytek IP
./setup-ipsec-tunnel.sh --draytek-ip 10.0.0.1
```

### Manual Configuration

If you prefer manual configuration, follow these steps:

#### External Server (StrongSwan)

1. **Install StrongSwan:**
   ```bash
   dnf install -y strongswan strongswan-charon strongswan-libipsec
   ```

2. **Configure swanctl.conf:**
   ```bash
   cat > /etc/swanctl/swanctl.conf << 'EOF'
   connections {
       draytek-tunnel {
           version = 2
           local_addrs = 195.95.177.8
           remote_addrs = 192.168.1.1

           local {
               auth = psk
               id = 195.95.177.8
           }

           remote {
               auth = psk
               id = 192.168.1.1
           }

           children {
               draytek-child {
                   local_ts = 195.95.177.0/28
                   remote_ts = 192.168.1.0/24
                   esp_proposals = aes256-sha256-modp2048
                   mode = tunnel
                   start_action = start
                   close_action = restart
               }
           }

           proposals = aes256-sha256-modp2048
           dpd_delay = 30s
           dpd_timeout = 120s
       }
   }

   secrets {
       ike-draytek {
           id-192.168.1.1 = "your-pre-shared-key"
           id-195.95.177.8 = "your-pre-shared-key"
       }
   }
   EOF
   ```

3. **Load configuration and start services:**
   ```bash
   swanctl --load-all
   systemctl enable strongswan
   systemctl start strongswan
   ```

## Monitoring and Troubleshooting

### Check Tunnel Status

**On External Server:**
```bash
# Monitor tunnel using the installed script
ssh -p 22123 root@195.95.177.8 /usr/local/bin/monitor-tunnel.sh

# Check tunnel status manually
ssh -p 22123 root@195.95.177.8 "swanctl --list-sas"

# View logs
ssh -p 22123 root@195.95.177.8 "journalctl -u strongswan -f"
```

**On Draytek:**
- Access web interface: `https://192.168.1.1`
- Go to **VPN and Remote Access > Connection Management**
- Check tunnel status and connection logs

### Common Issues and Solutions

#### 1. Tunnel Not Establishing
**Symptoms:** No SAs (Security Associations) shown in status
**Solutions:**
- Verify pre-shared key matches on both sides
- Check firewall rules allow UDP 500, 4500 and ESP protocol
- Ensure correct IP addresses are configured
- Verify network connectivity between devices

#### 2. Tunnel Established But No Traffic
**Symptoms:** SAs present but ping/traffic fails
**Solutions:**
- Check routing configuration on both devices
- Verify firewall rules allow the specific traffic
- Test with simple ping between networks
- Check NAT rules if internet access is required

#### 3. Frequent Disconnections
**Symptoms:** Tunnel connects but drops frequently
**Solutions:**
- Adjust DPD (Dead Peer Detection) settings
- Check for NAT timeout issues
- Verify network stability
- Review logs for error patterns

### Testing Connectivity

```bash
# Test from external server to internal network
ssh -p 22123 root@195.95.177.8 "ping -c 3 192.168.1.1"

# Test from internal network to external server
ping 195.95.177.8

# Check routing
ip route show table main
```

## Security Considerations

1. **Pre-Shared Key Security:**
   - Use strong, randomly generated keys (32+ characters)
   - Store keys securely and don't share via insecure channels
   - Rotate keys periodically

2. **Firewall Rules:**
   - Only allow necessary traffic through the tunnel
   - Implement strict ingress/egress filtering
   - Monitor for suspicious activity

3. **Certificate-based Authentication:**
   - Consider upgrading to certificate-based auth for enhanced security
   - The setup script generates certificates as a backup option

## Files Created by Setup Script

- **Configuration:** `/etc/swanctl/swanctl.conf`
- **Certificates:** `/etc/swanctl/x509/` and `/etc/swanctl/private/`
- **Firewall Rules:** `/etc/nftables/ipsec-config.nft`
- **Monitoring Script:** `/usr/local/bin/monitor-tunnel.sh`
- **Draytek Instructions:** `/tmp/draytek-config.txt`
- **Setup Log:** `/tmp/ipsec-setup-YYYYMMDD-HHMMSS.log`

## Support and Maintenance

### Regular Maintenance Tasks

1. **Monitor tunnel health:** Check logs weekly
2. **Update systems:** Keep StrongSwan and OS updated
3. **Review configuration:** Audit settings quarterly
4. **Test connectivity:** Perform monthly connectivity tests

### Performance Optimization

- **MTU Settings:** Configure appropriate MTU for encapsulated traffic
- **CPU Usage:** Monitor encryption overhead
- **Bandwidth:** Test throughput and optimize if needed

### Backup and Recovery

1. **Configuration Backup:**
   ```bash
   tar -czf ipsec-backup-$(date +%Y%m%d).tar.gz /etc/swanctl/
   ```

2. **Draytek Backup:** Use web interface to export configuration

### Getting Help

- **StrongSwan Documentation:** https://docs.strongswan.org/
- **Draytek Support:** https://www.draytek.com/support/
- **Script Issues:** Check log files and run with verbose output

## Conclusion

This setup provides a secure, routed IPSec tunnel between your external server and Draytek router. The automated script handles most of the complex configuration, while the manual steps ensure proper integration with your Draytek device.

For production use, consider implementing additional monitoring, alerting, and backup procedures to ensure reliable operation.
