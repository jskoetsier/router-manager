#!/bin/bash
# Router Manager Update Script

set -euo pipefail

INSTALL_DIR="/opt/router-manager"
LOG_FILE="/var/log/router-manager-update.log"

echo "$(date): Starting Router Manager update..." >> "$LOG_FILE"

if [[ ! -d "$INSTALL_DIR/.git" ]]; then
    echo "ERROR: Router Manager installation directory is not a git repository" >> "$LOG_FILE"
    exit 1
fi

cd "$INSTALL_DIR"

# Check for updates
echo "Checking for updates..." >> "$LOG_FILE"
git fetch origin >> "$LOG_FILE" 2>&1

LOCAL=$(git rev-parse HEAD)
REMOTE=$(git rev-parse @{u})

if [[ "$LOCAL" == "$REMOTE" ]]; then
    echo "Router Manager is already up to date." >> "$LOG_FILE"
    echo "Router Manager is already up to date."
    exit 0
fi

echo "Updates available, updating Router Manager..." >> "$LOG_FILE"

# Backup local changes if any
if [[ -n "$(git status --porcelain)" ]]; then
    echo "Backing up local changes..." >> "$LOG_FILE"
    git stash push -m "Auto-backup before update $(date)" >> "$LOG_FILE" 2>&1
fi

# Pull updates
git pull origin main >> "$LOG_FILE" 2>&1

# Restart services
echo "Restarting Router Manager service..." >> "$LOG_FILE"
systemctl restart router-manager >> "$LOG_FILE" 2>&1

echo "$(date): Router Manager updated successfully." >> "$LOG_FILE"
echo "Router Manager updated successfully!"

# Show new version
if [[ -f "$INSTALL_DIR/VERSION" ]]; then
    VERSION=$(cat "$INSTALL_DIR/VERSION")
    echo "Current version: $VERSION"
fi