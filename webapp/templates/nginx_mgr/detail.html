{% extends "base.html" %}

{% block title %}{{ config.name }} - Proxy Details{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-lg-8">
            <!-- Configuration Details -->
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h3 class="card-title">
                        <i class="fas fa-server text-primary"></i>
                        {{ config.name }}
                    </h3>
                    <div>
                        {% if config.is_active and not config.is_deployed %}
                        <form method="post" action="{% url 'nginx_mgr:deploy' config.pk %}" style="display: inline;">
                            {% csrf_token %}
                            <button type="submit" class="btn btn-success btn-sm me-2" 
                                    onclick="return confirm('Deploy this configuration to nginx?')">
                                <i class="fas fa-rocket"></i> Deploy
                            </button>
                        </form>
                        {% elif config.is_deployed %}
                        <form method="post" action="{% url 'nginx_mgr:undeploy' config.pk %}" style="display: inline;">
                            {% csrf_token %}
                            <button type="submit" class="btn btn-warning btn-sm me-2" 
                                    onclick="return confirm('Remove this configuration from deployment?')">
                                <i class="fas fa-stop"></i> Undeploy
                            </button>
                        </form>
                        {% endif %}
                        
                        <a href="{% url 'nginx_mgr:edit' config.pk %}" class="btn btn-outline-secondary btn-sm">
                            <i class="fas fa-edit"></i> Edit
                        </a>
                    </div>
                </div>

                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h5>Basic Information</h5>
                            <table class="table table-sm">
                                <tr>
                                    <td><strong>Name:</strong></td>
                                    <td>{{ config.name }}</td>
                                </tr>
                                <tr>
                                    <td><strong>Domain:</strong></td>
                                    <td>
                                        <span class="badge bg-light text-dark">{{ config.domain_name }}</span>
                                        {% if config.ssl_enabled %}
                                        <a href="https://{{ config.domain_name }}" target="_blank" class="btn btn-sm btn-outline-primary ms-2">
                                            <i class="fas fa-external-link-alt"></i> Visit
                                        </a>
                                        {% endif %}
                                    </td>
                                </tr>
                                <tr>
                                    <td><strong>Upstream:</strong></td>
                                    <td><code>{{ config.get_upstream_url }}</code></td>
                                </tr>
                                <tr>
                                    <td><strong>Status:</strong></td>
                                    <td>
                                        {% if config.is_active %}
                                            {% if config.is_deployed %}
                                                <span class="badge bg-success">
                                                    <i class="fas fa-check-circle"></i> Active & Deployed
                                                </span>
                                            {% else %}
                                                <span class="badge bg-warning">
                                                    <i class="fas fa-pause-circle"></i> Active (Not Deployed)
                                                </span>
                                            {% endif %}
                                        {% else %}
                                            <span class="badge bg-secondary">
                                                <i class="fas fa-stop-circle"></i> Inactive
                                            </span>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% if config.deployed_at %}
                                <tr>
                                    <td><strong>Deployed:</strong></td>
                                    <td>{{ config.deployed_at|date:"Y-m-d H:i:s" }}</td>
                                </tr>
                                {% endif %}
                            </table>
                        </div>
                        
                        <div class="col-md-6">
                            <h5>SSL Configuration</h5>
                            <table class="table table-sm">
                                <tr>
                                    <td><strong>SSL Enabled:</strong></td>
                                    <td>
                                        {% if config.ssl_enabled %}
                                            <span class="badge bg-success"><i class="fas fa-check"></i> Yes</span>
                                        {% else %}
                                            <span class="badge bg-secondary"><i class="fas fa-times"></i> No</span>
                                        {% endif %}
                                    </td>
                                </tr>
                                <tr>
                                    <td><strong>Auto SSL:</strong></td>
                                    <td>
                                        {% if config.auto_ssl %}
                                            <span class="badge bg-success"><i class="fas fa-check"></i> Yes</span>
                                        {% else %}
                                            <span class="badge bg-secondary"><i class="fas fa-times"></i> No</span>
                                        {% endif %}
                                    </td>
                                </tr>
                                <tr>
                                    <td><strong>Force HTTPS:</strong></td>
                                    <td>
                                        {% if config.force_https %}
                                            <span class="badge bg-success"><i class="fas fa-check"></i> Yes</span>
                                        {% else %}
                                            <span class="badge bg-secondary"><i class="fas fa-times"></i> No</span>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% if ssl_cert %}
                                <tr>
                                    <td><strong>Certificate:</strong></td>
                                    <td>
                                        {% if ssl_cert.is_expiring_soon %}
                                            <span class="badge bg-warning">Expires {{ ssl_cert.expiry_date|date:"Y-m-d" }}</span>
                                        {% else %}
                                            <span class="badge bg-success">Valid until {{ ssl_cert.expiry_date|date:"Y-m-d" }}</span>
                                        {% endif %}
                                        {% if config.ssl_enabled and config.auto_ssl %}
                                        <form method="post" action="{% url 'nginx_mgr:ssl_renew' config.pk %}" style="display: inline;">
                                            {% csrf_token %}
                                            <button type="submit" class="btn btn-sm btn-outline-info ms-2" 
                                                    onclick="return confirm('Renew SSL certificate?')">
                                                <i class="fas fa-sync"></i> Renew
                                            </button>
                                        </form>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endif %}
                            </table>
                        </div>
                    </div>

                    {% if config.description %}
                    <div class="mt-3">
                        <h6>Description:</h6>
                        <p class="text-muted">{{ config.description }}</p>
                    </div>
                    {% endif %}

                    {% if config.custom_headers %}
                    <div class="mt-3">
                        <h6>Custom Headers:</h6>
                        <pre class="bg-light p-2 rounded"><code>{{ config.custom_headers|pprint }}</code></pre>
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- Deployment Logs -->
            {% if deployment_logs %}
            <div class="card mt-4">
                <div class="card-header">
                    <h4 class="card-title">
                        <i class="fas fa-history text-info"></i>
                        Recent Deployment History
                    </h4>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>Action</th>
                                    <th>Status</th>
                                    <th>Started</th>
                                    <th>Duration</th>
                                    <th>Message</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for log in deployment_logs %}
                                <tr>
                                    <td>
                                        <span class="badge bg-light text-dark">{{ log.get_action_display }}</span>
                                    </td>
                                    <td>
                                        {% if log.status == 'success' %}
                                            <span class="badge bg-success">Success</span>
                                        {% elif log.status == 'failed' %}
                                            <span class="badge bg-danger">Failed</span>
                                        {% elif log.status == 'in_progress' %}
                                            <span class="badge bg-info">In Progress</span>
                                        {% else %}
                                            <span class="badge bg-secondary">{{ log.get_status_display }}</span>
                                        {% endif %}
                                    </td>
                                    <td>{{ log.started_at|date:"Y-m-d H:i:s" }}</td>
                                    <td>
                                        {% if log.completed_at %}
                                            {{ log.completed_at|timesince:log.started_at }}
                                        {% else %}
                                            -
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if log.message %}
                                            <small>{{ log.message|truncatechars:100 }}</small>
                                        {% else %}
                                            -
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    <div class="text-end">
                        <a href="{% url 'nginx_mgr:logs' %}?config={{ config.pk }}" class="btn btn-sm btn-outline-info">
                            View All Logs
                        </a>
                    </div>
                </div>
            </div>
            {% endif %}
        </div>

        <!-- Sidebar -->
        <div class="col-lg-4">
            <!-- System Status -->
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title">
                        <i class="fas fa-server text-success"></i>
                        System Status
                    </h5>
                </div>
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <span>Nginx Service:</span>
                        {% if nginx_status.running %}
                            <span class="badge bg-success">Running</span>
                        {% else %}
                            <span class="badge bg-danger">Stopped</span>
                        {% endif %}
                    </div>
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <span>Configuration:</span>
                        {% if nginx_status.config_valid %}
                            <span class="badge bg-success">Valid</span>
                        {% else %}
                            <span class="badge bg-danger">Invalid</span>
                        {% endif %}
                    </div>
                    <div class="d-flex justify-content-between align-items-center">
                        <span>Version:</span>
                        <code class="small">{{ nginx_status.version }}</code>
                    </div>
                </div>
            </div>

            <!-- Quick Actions -->
            <div class="card mt-3">
                <div class="card-header">
                    <h5 class="card-title">
                        <i class="fas fa-bolt text-warning"></i>
                        Quick Actions
                    </h5>
                </div>
                <div class="card-body">
                    <div class="d-grid gap-2">
                        <a href="{% url 'nginx_mgr:status' %}" class="btn btn-outline-info btn-sm">
                            <i class="fas fa-chart-line"></i> System Status
                        </a>
                        <a href="{% url 'nginx_mgr:logs' %}" class="btn btn-outline-secondary btn-sm">
                            <i class="fas fa-file-alt"></i> All Deployment Logs
                        </a>
                        <a href="{% url 'nginx_mgr:list' %}" class="btn btn-outline-primary btn-sm">
                            <i class="fas fa-list"></i> All Configurations
                        </a>
                    </div>
                </div>
            </div>

            <!-- Configuration Export -->
            <div class="card mt-3">
                <div class="card-header">
                    <h5 class="card-title">
                        <i class="fas fa-download text-info"></i>
                        Export Configuration
                    </h5>
                </div>
                <div class="card-body">
                    <p class="small text-muted">
                        Download the generated nginx configuration file for manual review or backup.
                    </p>
                    <button class="btn btn-outline-info btn-sm w-100" onclick="downloadConfig()">
                        <i class="fas fa-file-code"></i> Download nginx.conf
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
function downloadConfig() {
    // This would generate and download the nginx configuration
    alert('Configuration download feature - to be implemented');
}

// Auto-refresh status every 30 seconds
setInterval(function() {
    $.get('{% url "nginx_mgr:ajax_status" config.pk %}')
        .done(function(data) {
            if (data.success) {
                // Update status indicators
                console.log('Status updated:', data.data);
            }
        })
        .fail(function() {
            console.log('Failed to update status');
        });
}, 30000);
</script>
{% endblock %}