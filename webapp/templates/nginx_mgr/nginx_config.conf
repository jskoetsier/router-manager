t work.d p is # Nginx configuration for {{ config.domain_name }}
# Generated by Router Manager - {{ config.name }}
# Created: {{ config.created_at|date:"Y-m-d H:i:s" }}

{% if config.rate_limit_enabled %}
# Rate limiting zone
limit_req_zone $binary_remote_addr zone={{ config.name }}_limit:10m rate={{ config.rate_limit_rpm }}r/m;
{% endif %}

# Upstream server configuration
upstream {{ config.name }}_backend {
    server {{ config.upstream_host }}:{{ config.upstream_port }};
    keepalive 32;
}

{% if config.ssl_enabled and config.force_https %}
# HTTP to HTTPS redirect
server {
    listen 80;
    server_name {{ config.domain_name }};

    # Let's Encrypt challenge location
    location /.well-known/acme-challenge/ {
        root /var/www/certbot;
        try_files $uri =404;
    }

    # Redirect all other traffic to HTTPS
    location / {
        return 301 https://$server_name$request_uri;
    }
}
{% endif %}

# Main server configuration
server {
    {% if config.ssl_enabled %}
    listen 443 ssl http2;
    {% else %}
    listen 80;
    {% endif %}

    server_name {{ config.domain_name }};

    {% if config.ssl_enabled %}
    # SSL configuration
    ssl_certificate {{ ssl_cert_path }};
    ssl_certificate_key {{ ssl_key_path }};

    # Modern SSL configuration
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers ECDHE-RSA-AES256-GCM-SHA512:DHE-RSA-AES256-GCM-SHA512:ECDHE-RSA-AES256-GCM-SHA384:DHE-RSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-SHA384;
    ssl_prefer_server_ciphers off;
    ssl_session_cache shared:SSL:10m;
    ssl_session_timeout 10m;
    ssl_stapling on;
    ssl_stapling_verify on;

    # Security headers
    add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;
    add_header X-Frame-Options DENY always;
    add_header X-Content-Type-Options nosniff always;
    add_header X-XSS-Protection "1; mode=block" always;
    add_header Referrer-Policy "strict-origin-when-cross-origin" always;
    {% endif %}

    # General security headers (for both HTTP and HTTPS)
    add_header X-Robots-Tag "noindex, nofollow" always;

    {% if config.custom_headers %}
    # Custom headers
    {% for header_name, header_value in config.custom_headers.items %}
    add_header "{{ header_name }}" "{{ header_value }}" always;
    {% endfor %}
    {% endif %}

    # Client configuration
    client_max_body_size 100M;
    client_body_timeout 60s;
    client_header_timeout 60s;

    {% if config.rate_limit_enabled %}
    # Rate limiting
    limit_req zone={{ config.name }}_limit burst=20 nodelay;
    limit_req_status 429;
    {% endif %}

    # Logging
    {% if config.access_log_enabled %}
    access_log /var/log/nginx/{{ config.name }}_access.log combined;
    {% else %}
    access_log off;
    {% endif %}

    {% if config.error_log_enabled %}
    error_log /var/log/nginx/{{ config.name }}_error.log warn;
    {% else %}
    error_log /dev/null crit;
    {% endif %}

    # Let's Encrypt challenge location (for SSL renewal)
    location /.well-known/acme-challenge/ {
        root /var/www/certbot;
        try_files $uri =404;
    }

    # Main proxy configuration
    location / {
        proxy_pass {{ config.get_upstream_url }};

        # Proxy headers
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        {% if config.ssl_enabled %}
        proxy_set_header X-Forwarded-Proto https;
        {% else %}
        proxy_set_header X-Forwarded-Proto http;
        {% endif %}
        proxy_set_header X-Forwarded-Host $server_name;

        # Proxy timeouts
        proxy_connect_timeout {{ config.proxy_connect_timeout }}s;
        proxy_send_timeout {{ config.proxy_send_timeout }}s;
        proxy_read_timeout {{ config.proxy_read_timeout }}s;

        # Proxy buffering
        proxy_buffering on;
        proxy_buffer_size 4k;
        proxy_buffers 8 4k;
        proxy_busy_buffers_size 8k;

        # HTTP version and connection handling
        proxy_http_version 1.1;
        proxy_set_header Connection "";

        # Disable proxy redirect following
        proxy_redirect off;

        # Handle WebSocket connections
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection $connection_upgrade;
    }

    # Health check endpoint (optional)
    location /nginx-health {
        access_log off;
        return 200 "healthy\n";
        add_header Content-Type text/plain;
    }

    # Security: Block access to sensitive files
    location ~ /\. {
        deny all;
        access_log off;
        log_not_found off;
    }

    location ~ \.(env|log|conf)$ {
        deny all;
        access_log off;
        log_not_found off;
    }
}

# Connection upgrade map for WebSocket support
map $http_upgrade $connection_upgrade {
    default upgrade;
    '' close;
}
